<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Apple Music Downloader</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-dark text-light">

<div class="container-fluid p-3">
    <!-- Top bar -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <button class="btn btn-outline-light" onclick="window.location.href='/settings'">⚙ Settings</button>
        </div>
        <div>
            <span id="wrapper-indicator"
                  class="badge {{ 'bg-success' if wrapper_running else 'bg-danger' }}">
                Wrapper: {{ 'Running' if wrapper_running else 'Stopped' }}
            </span>
        </div>
    </div>

    <!-- Login Section -->
    <div class="text-center mb-3">
        <button id="login-btn" class="btn btn-secondary">Login to Wrapper</button>
        <button id="stop-wrapper-btn" class="btn btn-danger ms-2 d-none">Stop Wrapper</button>
        <div id="login-form" class="mt-3 d-none">
            <input type="email" id="email" placeholder="Email" class="form-control mb-2 w-25 mx-auto">
            <input type="password" id="password" placeholder="Password" class="form-control mb-2 w-25 mx-auto">
            <button id="submit-login" class="btn btn-success">Login</button>
        </div>
    </div>

    <!-- Middle input area -->
    <div class="text-center mb-4">
        <input id="link-box" type="text" class="form-control form-control-lg mb-3 w-50 mx-auto"
               placeholder="Paste Apple Music link here">

        <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="format" id="atmos" value="ATMOS" checked>
            <label class="form-check-label" for="atmos">ATMOS</label>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="format" id="aac" value="AAC">
            <label class="form-check-label" for="aac">AAC</label>
        </div>

        <div class="mt-3">
            <button id="download-btn" class="btn btn-primary btn-lg" disabled>Download</button>
        </div>
    </div>

    <!-- Bottom logs -->
    <div class="row">
        <div class="col-md-6">
            <h5>Downloader Logs</h5>
            <div class="log-box" id="downloader-logs"></div>
        </div>
        <div class="col-md-6">
            <h5>Wrapper Logs</h5>
            <div class="log-box" id="wrapper-logs"></div>
        </div>
    </div>
</div>

<script>
document.getElementById("login-btn").addEventListener("click", () => {
    document.getElementById("login-form").classList.toggle("d-none");
});

document.getElementById("submit-login").addEventListener("click", () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    
    // Add immediate feedback
    const wrapperLogs = document.getElementById("wrapper-logs");
    wrapperLogs.innerHTML += `<div>> Attempting to login with ${email}...</div>`;
    wrapperLogs.scrollTop = wrapperLogs.scrollHeight;

    axios.post("/login_wrapper", new URLSearchParams({email, password}))
        .then(res => {
            if (res.data.status === "ok") {
                // Don't immediately set as running - wait for the success message in logs
                wrapperLogs.innerHTML += `<div>> ${res.data.msg}</div>`;
            } else {
                wrapperLogs.innerHTML += `<div>> ERROR: ${res.data.msg}</div>`;
            }
            wrapperLogs.scrollTop = wrapperLogs.scrollHeight;
        })
        .catch(err => {
            wrapperLogs.innerHTML += `<div>> ERROR: Failed to connect to server</div>`;
            wrapperLogs.scrollTop = wrapperLogs.scrollHeight;
        });
});

document.getElementById("download-btn").addEventListener("click", () => {
    const link = document.getElementById("link-box").value;
    const format = document.querySelector("input[name='format']:checked").value;

    axios.post("/download", new URLSearchParams({ link, format }))
        .then(res => {
            const logs = document.getElementById("downloader-logs");
            logs.innerHTML += `<div>> ${res.data.msg}</div>`;
            logs.scrollTop = logs.scrollHeight;
        });
});

document.getElementById("stop-wrapper-btn").addEventListener("click", () => {
    axios.post("/stop_wrapper")
        .then(res => {
            const wrapperLogs = document.getElementById("wrapper-logs");
            wrapperLogs.innerHTML += `<div>> ${res.data.msg}</div>`;
            wrapperLogs.scrollTop = wrapperLogs.scrollHeight;
            
            if (res.data.status === "ok") {
                updateWrapperStatus(false);
            }
        });
});

function updateWrapperStatus(running) {
    const indicator = document.getElementById("wrapper-indicator");
    const downloadBtn = document.getElementById("download-btn");
    const stopBtn = document.getElementById("stop-wrapper-btn");
    
    if (running) {
        indicator.className = "badge bg-success";
        indicator.innerText = "Wrapper: Running";
        downloadBtn.disabled = false;
        stopBtn.classList.remove("d-none");
    } else {
        indicator.className = "badge bg-danger";
        indicator.innerText = "Wrapper: Stopped";
        downloadBtn.disabled = true;
        stopBtn.classList.add("d-none");
    }
}

function updateLogs() {
    axios.get("/get_logs").then(res => {
        const wrapperBox = document.getElementById("wrapper-logs");
        const downloaderBox = document.getElementById("downloader-logs");

        // Only update if there are actually logs to show
        if (res.data.wrapper.length > 0) {
            // Color-code success and error messages
            wrapperBox.innerHTML = res.data.wrapper.map(l => {
                if (l.includes("✅") || l.includes("Ready for downloads")) {
                    return `<div style="color: #28a745;">> ${l}</div>`;
                } else if (l.includes("❌") || l.includes("Login failed") || l.includes("ERROR")) {
                    return `<div style="color: #dc3545;">> ${l}</div>`;
                } else if (l.includes("[.] response type 6")) {
                    return `<div style="color: #28a745; font-weight: bold;">> ${l}</div>`;
                } else {
                    return `<div>> ${l}</div>`;
                }
            }).join("");
            wrapperBox.scrollTop = wrapperBox.scrollHeight;
        }
        
        if (res.data.downloader.length > 0) {
            downloaderBox.innerHTML = res.data.downloader.map(l => `<div>> ${l}</div>`).join("");
            downloaderBox.scrollTop = downloaderBox.scrollHeight;
        }
        
        // Update wrapper status based on server response
        updateWrapperStatus(res.data.wrapper_running);
        
    }).catch(err => {
        console.log("Error fetching logs:", err);
    });
}

// Start polling immediately and then every 1 second for better responsiveness
updateLogs();
setInterval(updateLogs, 1000);
</script>
</body>
</html>
