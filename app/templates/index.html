<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Apple Music Downloader</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-dark text-light">

<div class="container-fluid p-3">
    <!-- Top bar -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <button class="btn btn-outline-light" onclick="window.location.href='/settings'">‚öô Settings</button>
        </div>
        <div>
            <span id="wrapper-indicator"
                  class="badge {{ 'bg-success' if wrapper_running else 'bg-danger' }}">
                Wrapper: {{ 'Running' if wrapper_running else 'Stopped' }}
            </span>
        </div>
    </div>

    <!-- Login Section -->
    <div class="text-center mb-3">
        <button id="login-btn" class="btn btn-secondary">Login to Wrapper</button>
        <button id="stop-wrapper-btn" class="btn btn-danger ms-2 d-none">Stop Wrapper</button>
        <button id="auto-login-btn" class="btn btn-info ms-2 d-none">ü§ñ Auto Login</button>
        <button id="forget-credentials-btn" class="btn btn-warning ms-2 d-none">üóëÔ∏è Forget Credentials</button>
        
        <div id="saved-credentials-info" class="mt-2 d-none">
            <small class="text-success">üíæ Saved credentials for: <span id="saved-email-display"></span></small>
        </div>
        
        <div id="login-form" class="mt-3 d-none">
            <input type="email" id="email" placeholder="Email" class="form-control mb-2 w-25 mx-auto">
            <input type="password" id="password" placeholder="Password" class="form-control mb-2 w-25 mx-auto">
            <button id="submit-login" class="btn btn-success">Login</button>
        </div>
    </div>

    <!-- Middle input area -->
    <div class="text-center mb-4">
        <input id="link-box" type="text" class="form-control form-control-lg mb-3 w-50 mx-auto"
               placeholder="Paste Apple Music link here">

        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="special-audio" checked>
            <label class="form-check-label" for="special-audio">Special Audio</label>
        </div>
        
        <div id="format-options" class="border rounded p-3 mb-3" style="background-color: #333; border-color: #555;">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="format" id="atmos" value="ATMOS" checked>
                <label class="form-check-label" for="atmos">ATMOS</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="format" id="aac" value="AAC">
                <label class="form-check-label" for="aac">AAC</label>
            </div>
        </div>

        <div class="mt-3">
            <button id="download-btn" class="btn btn-primary btn-lg" disabled>Download</button>
        </div>
    </div>

    <!-- Bottom logs -->
    <div class="row">
        <div class="col-md-6">
            <h5>Downloader Logs</h5>
            <div class="log-box" id="downloader-logs"></div>
        </div>
        <div class="col-md-6">
            <h5>Wrapper Logs</h5>
            <div class="log-box" id="wrapper-logs"></div>
        </div>
    </div>
</div>

<script>
// Check for saved credentials on page load
function checkSavedCredentials() {
    axios.get('/check_saved_credentials')
        .then(res => {
            if (res.data.has_credentials) {
                document.getElementById('saved-credentials-info').classList.remove('d-none');
                document.getElementById('saved-email-display').textContent = res.data.email;
                document.getElementById('auto-login-btn').classList.remove('d-none');
                document.getElementById('forget-credentials-btn').classList.remove('d-none');
            }
        });
}

// Auto-login functionality
document.getElementById('auto-login-btn').addEventListener('click', () => {
    const wrapperLogs = document.getElementById('wrapper-logs');
    wrapperLogs.innerHTML += `<div>> ü§ñ Starting auto-login...</div>`;
    wrapperLogs.scrollTop = wrapperLogs.scrollHeight;
    
    axios.post('/auto_login')
        .then(res => {
            if (res.data.status === 'ok') {
                wrapperLogs.innerHTML += `<div>> ${res.data.msg}</div>`;
            } else {
                wrapperLogs.innerHTML += `<div>> ‚ùå ${res.data.msg}</div>`;
            }
            wrapperLogs.scrollTop = wrapperLogs.scrollHeight;
        });
});

// Forget credentials functionality
document.getElementById('forget-credentials-btn').addEventListener('click', () => {
    if (confirm('Are you sure you want to delete saved credentials?')) {
        axios.post('/delete_saved_credentials')
            .then(res => {
                if (res.data.status === 'ok') {
                    document.getElementById('saved-credentials-info').classList.add('d-none');
                    document.getElementById('auto-login-btn').classList.add('d-none');
                    document.getElementById('forget-credentials-btn').classList.add('d-none');
                    
                    const wrapperLogs = document.getElementById('wrapper-logs');
                    wrapperLogs.innerHTML += `<div>> üóëÔ∏è Saved credentials deleted</div>`;
                    wrapperLogs.scrollTop = wrapperLogs.scrollHeight;
                }
            });
    }
});

document.getElementById("login-btn").addEventListener("click", () => {
    document.getElementById("login-form").classList.toggle("d-none");
});

document.getElementById("submit-login").addEventListener("click", () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    
    // Add immediate feedback
    const wrapperLogs = document.getElementById("wrapper-logs");
    wrapperLogs.innerHTML += `<div>> Attempting to login with ${email}...</div>`;
    wrapperLogs.scrollTop = wrapperLogs.scrollHeight;

    axios.post("/login_wrapper", new URLSearchParams({email, password}))
        .then(res => {
            if (res.data.status === "ok") {
                // Don't immediately set as running - wait for the success message in logs
                wrapperLogs.innerHTML += `<div>> ${res.data.msg}</div>`;
            } else {
                wrapperLogs.innerHTML += `<div>> ERROR: ${res.data.msg}</div>`;
            }
            wrapperLogs.scrollTop = wrapperLogs.scrollHeight;
        })
        .catch(err => {
            wrapperLogs.innerHTML += `<div>> ERROR: Failed to connect to server</div>`;
            wrapperLogs.scrollTop = wrapperLogs.scrollHeight;
        });
});

document.getElementById("download-btn").addEventListener("click", () => {
    const link = document.getElementById("link-box").value;
    const format = document.querySelector("input[name='format']:checked")?.value || "ATMOS";
    const specialAudio = document.getElementById("special-audio").checked;
    
    if (!link.trim()) {
        const logs = document.getElementById("downloader-logs");
        logs.innerHTML += `<div style="color: #dc3545;"> ‚ùå Please enter a valid Apple Music URL</div>`;
        logs.scrollTop = logs.scrollHeight;
        return;
    }

    const formData = new URLSearchParams({
        link: link,
        format: format,
        special_audio: specialAudio
    });

    axios.post("/download", formData)
        .then(res => {
            const logs = document.getElementById("downloader-logs");
            if (res.data.status === "ok") {
                logs.innerHTML += `<div style="color: #28a745;"> ‚úÖ ${res.data.msg}</div>`;
                // Disable download button while download is running
                document.getElementById("download-btn").disabled = true;
                document.getElementById("download-btn").textContent = "Downloading...";
            } else {
                logs.innerHTML += `<div style="color: #dc3545;"> ‚ùå ${res.data.msg}</div>`;
            }
            logs.scrollTop = logs.scrollHeight;
        })
        .catch(err => {
            const logs = document.getElementById("downloader-logs");
            logs.innerHTML += `<div style="color: #dc3545;"> ‚ùå Failed to start download</div>`;
            logs.scrollTop = logs.scrollHeight;
        });
});

document.getElementById("stop-wrapper-btn").addEventListener("click", () => {
    axios.post("/stop_wrapper")
        .then(res => {
            const wrapperLogs = document.getElementById("wrapper-logs");
            wrapperLogs.innerHTML += `<div>> ${res.data.msg}</div>`;
            wrapperLogs.scrollTop = wrapperLogs.scrollHeight;
            
            if (res.data.status === "ok") {
                updateWrapperStatus(false);
            }
        });
});

function updateWrapperStatus(running) {
    const indicator = document.getElementById("wrapper-indicator");
    const downloadBtn = document.getElementById("download-btn");
    const stopBtn = document.getElementById("stop-wrapper-btn");
    
    if (running) {
        indicator.className = "badge bg-success";
        indicator.innerText = "Wrapper: Running";
        downloadBtn.disabled = false;
        stopBtn.classList.remove("d-none");
    } else {
        indicator.className = "badge bg-danger";
        indicator.innerText = "Wrapper: Stopped";
        downloadBtn.disabled = true;
        stopBtn.classList.add("d-none");
    }
}

function updateLogs() {
    axios.get("/get_logs").then(res => {
        const wrapperBox = document.getElementById("wrapper-logs");
        const downloaderBox = document.getElementById("downloader-logs");
        const downloadBtn = document.getElementById("download-btn");

        // Only update if there are actually logs to show
        if (res.data.wrapper.length > 0) {
            // Color-code success and error messages
            wrapperBox.innerHTML = res.data.wrapper.map(l => {
                if (l.includes("‚úÖ") || l.includes("Ready for downloads")) {
                    return `<div style="color: #28a745;">> ${l}</div>`;
                } else if (l.includes("‚ùå") || l.includes("Login failed") || l.includes("ERROR")) {
                    return `<div style="color: #dc3545;">> ${l}</div>`;
                } else if (l.includes("[.] response type 6")) {
                    return `<div style="color: #28a745; font-weight: bold;">> ${l}</div>`;
                } else {
                    return `<div>> ${l}</div>`;
                }
            }).join("");
            wrapperBox.scrollTop = wrapperBox.scrollHeight;
        }
        
        if (res.data.downloader.length > 0) {
            // Color-code download messages
            downloaderBox.innerHTML = res.data.downloader.map(l => {
                if (l.includes("‚úÖ") || l.includes("completed successfully")) {
                    return `<div style="color: #28a745;">> ${l}</div>`;
                } else if (l.includes("‚ùå") || l.includes("failed") || l.includes("Error")) {
                    return `<div style="color: #dc3545;">> ${l}</div>`;
                } else if (l.includes("üéµ") || l.includes("Starting")) {
                    return `<div style="color: #17a2b8;">> ${l}</div>`;
                } else {
                    return `<div>> ${l}</div>`;
                }
            }).join("");
            downloaderBox.scrollTop = downloaderBox.scrollHeight;
        }
        
        // Update download button state based on download status
        if (res.data.download_running) {
            downloadBtn.disabled = true;
            downloadBtn.textContent = "Downloading...";
        } else {
            if (res.data.wrapper_running) {
                downloadBtn.disabled = false;
                downloadBtn.textContent = "Download";
            }
        }
        
        // Update wrapper status based on server response
        updateWrapperStatus(res.data.wrapper_running);
        
    }).catch(err => {
        console.log("Error fetching logs:", err);
    });
}

// Start polling immediately and then every 1 second for better responsiveness
updateLogs();
setInterval(updateLogs, 1000);

// Check for saved credentials when page loads
checkSavedCredentials();

// Handle Special Audio checkbox toggle
document.getElementById('special-audio').addEventListener('change', function() {
    const formatOptions = document.getElementById('format-options');
    const radioButtons = formatOptions.querySelectorAll('input[type="radio"]');
    
    if (this.checked) {
        formatOptions.style.opacity = '1';
        radioButtons.forEach(radio => radio.disabled = false);
    } else {
        formatOptions.style.opacity = '0.5';
        radioButtons.forEach(radio => radio.disabled = true);
    }
});
</script>
</body>
</html>
